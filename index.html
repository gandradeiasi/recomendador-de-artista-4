<!DOCTYPE html>
<html>
<head>
    <title>Análise de Músicas Curtidas</title>
</head>
<body>
    <button id="loginBtn">Login com Spotify</button>
    <div id="progress"></div>
    <div id="result"></div>

    <script>
        const clientId = 'cdbe0b644b984a6e98839e352d87bb3d';
        const redirectUri = 'https://gandradeiasi.github.io/recomendador-de-artista-4/';
        let accessToken = null;

        // Configurar o evento de login após o carregamento do DOM
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('loginBtn').addEventListener('click', login);
        });

        function login() {
            const scopes = ['user-library-read'];
            const authUrl = `https://accounts.spotify.com/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${scopes.join('%20')}&response_type=token&show_dialog=true`;
            window.location.href = authUrl;
        }

        function updateProgress(text) {
            document.getElementById('progress').innerHTML = text;
        }

        function getAccessToken() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            return params.get('access_token');
        }

        async function fetchAllLikedTracks(token) {
            let tracks = [];
            let url = 'https://api.spotify.com/v1/me/tracks?limit=50';
            
            while (url) {
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                tracks = tracks.concat(data.items);
                updateProgress(`Carregando músicas curtidas: ${tracks.length} itens...`);
                url = data.next;
            }
            return tracks;
        }

        async function fetchArtistsDetails(token, artistIds) {
            const artistMap = {};
            for (let i = 0; i < artistIds.length; i += 50) {
                const batch = artistIds.slice(i, i + 50);
                const response = await fetch(`https://api.spotify.com/v1/artists?ids=${batch.join(',')}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                data.artists.forEach(artist => {
                    artistMap[artist.id] = {
                        name: artist.name,
                        genres: artist.genres
                    };
                });
                updateProgress(`Carregando detalhes de artistas: ${Object.keys(artistMap).length} itens...`);
            }
            return artistMap;
        }

        function calculateGenreCounts(tracks, artistMap) {
            const genreCounts = {};
            
            tracks.forEach(track => {
                const genres = new Set();
                track.track.artists.forEach(artist => {
                    const artistGenres = artistMap[artist.id]?.genres || [];
                    artistGenres.forEach(genre => genres.add(genre));
                });
                genres.forEach(genre => {
                    genreCounts[genre] = (genreCounts[genre] || 0) + 1;
                });
            });
            
            return genreCounts;
        }

        function findElbowGenre(genreCounts) {
            const sortedGenres = Object.entries(genreCounts).sort((a, b) => b[1] - a[1]);
            const values = sortedGenres.map(g => g[1]);

            if (values.length <= 1) return sortedGenres[0]?.[0];

            const firstDerivative = [];
            for (let i = 1; i < values.length; i++) {
                firstDerivative.push(values[i] - values[i - 1]);
            }

            const secondDerivative = [];
            for (let i = 1; i < firstDerivative.length; i++) {
                secondDerivative.push(firstDerivative[i] - firstDerivative[i - 1]);
            }

            let minIndex = 0;
            for (let i = 1; i < secondDerivative.length; i++) {
                if (secondDerivative[i] < secondDerivative[minIndex]) {
                    minIndex = i;
                }
            }

            return sortedGenres[minIndex + 1][0];
        }

        function findTopArtist(tracks, artistMap, elbowGenre) {
            const artistCounts = {};

            tracks.forEach(track => {
                const hasGenre = track.track.artists.some(artist => 
                    artistMap[artist.id]?.genres?.includes(elbowGenre)
                );

                if (hasGenre) {
                    track.track.artists.forEach(artist => {
                        if (artistMap[artist.id]?.genres?.includes(elbowGenre)) {
                            artistCounts[artist.id] = (artistCounts[artist.id] || 0) + 1;
                        }
                    });
                }
            });

            let maxCount = 0;
            let topArtists = [];
            Object.entries(artistCounts).forEach(([id, count]) => {
                if (count > maxCount) {
                    maxCount = count;
                    topArtists = [id];
                } else if (count === maxCount) {
                    topArtists.push(id);
                }
            });

            const randomIndex = Math.floor(Math.random() * topArtists.length);
            return artistMap[topArtists[randomIndex]]?.name || 'Nenhum artista encontrado';
        }

        async function main() {
            accessToken = getAccessToken();
            if (!accessToken) return;

            updateProgress('Carregando dados...');
            
            try {
                // Carregar músicas curtidas
                const likedTracks = await fetchAllLikedTracks(accessToken);
                
                // Extrair IDs de artistas únicos
                const artistIds = [...new Set(
                    likedTracks.flatMap(t => t.track.artists.map(a => a.id))
                )];

                // Carregar detalhes dos artistas
                const artistMap = await fetchArtistsDetails(accessToken, artistIds);

                // Calcular contagem de gêneros
                const genreCounts = calculateGenreCounts(likedTracks, artistMap);

                // Encontrar gênero do cotovelo
                const elbowGenre = findElbowGenre(genreCounts);

                // Encontrar
